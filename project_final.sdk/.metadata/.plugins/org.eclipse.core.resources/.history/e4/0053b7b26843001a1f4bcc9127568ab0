
#include "bram.h"
#include "platform.h"
#include "stdio.h"
#include "xadcps.h"
#include "xil_printf.h"
#include "xparameters.h"
#include "xstatus.h"


/****************************** Device IDs **********************************/
#define XADC_DEVICE_ID 		XPAR_XADCPS_0_DEVICE_ID

/************************** Function Prototypes *****************************/

static int XAdcPolledPrintfExample(u16 XAdcDeviceId, int offset, float* value);
static int XAdcFractionToInt(float FloatNum);

/***************** Macros (Inline Functions) Definitions ********************/

//Small foot-print printf function
#define printf xil_printf

// converting RAW data from external source to voltage
#define XAdcPs_ExternalRawToVoltage(AdcData)\
								((((float)(AdcData))* (1.0f))/65536.0f)

/************************** Variable Definitions ****************************/
static XAdcPs XAdcInst;      /* XADC driver instance */


/********************************** Main ************************************/
int main()
{
	// Initiation
	xil_printf("Initializing platform...\r\n");
	init_platform();
	xil_printf("Done.\r\n");
	initMemory();
	xil_printf("Welcome to Smart Battery Charging System!\r\n");

	int addr_value = 1;
	int battery_capacity = 0;
	int battery_nominal_voltage = 0;
	while(1)
	{
		xil_printf("Enter battery capacity: ");
		scanf("%d", &battery_capacity);
		xil_printf("%d\r\n", battery_capacity);
		xil_printf("Enter battery nominal voltage: ");
		scanf("%d", &battery_nominal_voltage);
		xil_printf("%d\r\n", battery_nominal_voltage);

		if (battery_capacity && battery_nominal_voltage)
			break;
		// PUT IN LIMITS???
	}

	xil_printf("\nCharge Status:\r\n");
	int Status;
	float value1;
	float value2;
	while(1)
	{
		Status = XAdcPolledPrintfExample(XADC_DEVICE_ID, 1, &value1);
		if (Status != XST_SUCCESS) {
			return XST_FAILURE;
		}
		Status = XAdcPolledPrintfExample(XADC_DEVICE_ID, 9, &value2);
		if (Status != XST_SUCCESS) {
			return XST_FAILURE;
		}
		printf("\033[2A");

		MYMEM_u(addr_value)=3;
	}

	return XST_SUCCESS;
	cleanup_platform();
	return 0;
}

int XAdcPolledPrintfExample(u16 XAdcDeviceId, int offset, float* value)
{
	int Status;
	XAdcPs_Config *ConfigPtr;
	u32 VccPdroRawData;
	float VccPintData;
	XAdcPs *XAdcInstPtr = &XAdcInst;

	//printf("\r\nEntering the XAdc Polled Example. \r\n");

	/*
	 * Initialize the XAdc driver.
	 */
	ConfigPtr = XAdcPs_LookupConfig(XAdcDeviceId);
	if (ConfigPtr == NULL) {
		return XST_FAILURE;
	}
	XAdcPs_CfgInitialize(XAdcInstPtr, ConfigPtr,
				ConfigPtr->BaseAddress);

	/*
	 * Self Test the XADC/ADC device
	 */
	Status = XAdcPs_SelfTest(XAdcInstPtr);
	if (Status != XST_SUCCESS) {
		return XST_FAILURE;
	}


	/*
	 * Read the AD14 input Voltage Data from the
	 * ADC data registers.
	 */
	VccPdroRawData = XAdcPs_GetAdcData(XAdcInstPtr, XADCPS_CH_AUX_MIN+offset);
	VccPintData = XAdcPs_ExternalRawToVoltage(VccPdroRawData)*3.3;
	printf("The Voltage on Channel %d is %0d.%03d Volts.   \r\n",
			offset, (int)(VccPintData), XAdcFractionToInt(VccPintData));

	//printf("\r\nExiting the XAdc Polled Example. \r\n");

	(*value) = VccPintData*3.3;

	return XST_SUCCESS;
}

int XAdcFractionToInt(float FloatNum)
{
	float Temp;

	Temp = FloatNum;
	if (FloatNum < 0) {
		Temp = -(FloatNum);
	}

	return( ((int)((Temp -(float)((int)Temp)) * (1000.0f))));
}
